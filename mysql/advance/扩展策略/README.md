---
title: mysql向外扩展_分布负载策略：复制，拆分，分片
desc:mysql分片策略，向外扩展策略，分布负载
keywords: mysql复制，拆分，分片，分布负载
author: douyacun
date: 2019-01-23
---

单台服务器性能有限，内存和磁盘肯定会成为瓶颈，这种时候就要考虑向外扩展了，最简单的常见的向外扩展方式一主多备的方式，备库用于查询，这里推荐使用主-主作为两台服务器的主动和被动节点

# 按功能拆分
将独立的服务器分配给不同的应用，这样每个节点只包含特定应用所需要的数据，应用指的是：不同的功能分区，不同的栏目，彼此分离，没有关联，这些不同区域的数据可以单独放在专用的mysql服务器上

# 数据分片
在目前用于扩展大型mysql的应用中，数据分片是最通用且最成功的方法，

## 选择分区键
目标是对那些频繁查询的数据减少分片(可扩展性法则有一条是：避免不同节点之间的交互)，选择分区键时尽量选择那些跨分片查询的，同时也要让分片足够小，以免过大的数据片导致问题，

## 多个分区键
许多应用需要多个多个分区键，特别是存在两个或更多个维度时，换句话说，应用需要从不同的角度看到有效且连贯的数据视图，这意味着数据外系统内至少存储两份

## 跨分片查询
大部分分片应用多少有一些查询需要对多个分片的数据进行聚合或关键操作，解决方案：
- 缓存
- 跨片查询可以借助汇总表来执行

## 分配数据、分片、节点
分片和节点不是一对一的关系，应尽可能的让分片的大小比节点容量小很多，在单个节点上存储多个分片

保持分片足够小更容易管理，这将使数据的备份和恢复更加容易，eg. alter table、check table、 optimize table.


# 生成全局唯一id
单一数据库可以使用auto_increament来生成全局唯一id,但涉及到多台服务器时就凑效了，一下是解决方案：

## auto_increment_increment 和 auto_increment_offset
这两个服务器变量可以让mysql以期望值和偏移量来增加auto_increament的值。

eg. 简单的场景，只有两台服务器，可以配置这两台服务器的自增幅度为2,其中一台偏移量设置为1，另一台设置为2(都不可以为0)

这种方法比较简单，并且不依赖于某个节点，因此是生成唯一id比较普遍的方法，需要仔细配置服务器，很容易因为错误配置生成重复数字，特别是增加服务器改变角色，进行灾难恢复时

## 全局节点中创建表
在一个全局节点中创建一个包含auto_increment列的表，应用可以通过这个表来生成唯一id

## 使用memcached
在memcached的api中，有一个incr()函数可以自动增长并返回结果，另外可以使用redis

## 批量分配数字
可以从一个全局节点中申请一批数字用完后再申请

## 使用复合值
可以使用复合值，如分片号和自增数的组合，
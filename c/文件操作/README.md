# 文件操作

## 文件和流
C将每个文件简单的作为顺序字节流, 开始执行程序时自动打开3个文件和相关的流: 标准输入, 标准输出, 标准错误;
**流提供了文件和程序的通信通道**, 打开一个文件将返回指向FILE结构(在stdio.h中定义)的指针, 包含用于处理文件的信息

> 文件描述符: 操作系统数组(打开文件列表的索引), 每个数组元素包含一个文件控制块, 操作新提供用它来管理特定的文件;
标准输入,标准输出和标准错误是用文件指针stdin,stdout,stderr 来处理的

## FILE结构体
stdio.h头文件中，定义了用于文件操作的结构体FILE, fopen返回一个文件指针

```
struct _iobuf {
        char *_ptr;
        int   _cnt;
        char *_base;
        int   _flag;
        int   _file;
        int   _charbuf;
        int   _bufsiz;
        char *_tmpfname;
        };
typedef struct _iobuf FILE;
```

FILE结构是间接的实现对文件的操作的, _file 实际上是一个描述符,作为进入打开文件表索引的整数;

## 科普
文件是存放在物理磁盘上的, 包括文件控制块(FCB)和数据块;

1. 文件控制块包括文件权限, 日期(创建,读取, 修改), 拥有者, 文件大小, 数据块信息;
2. 数据块用来存储实际的内容

操作系统管理打开的文件, 维护两张表, 一张系统级打开文件表, 一张进程及打开文件表,系统级打开文件表复制了文件控制块的信息;
进城级打开文件表保存了指向系统级别文件的指针及其他信息,

- 系统级文件表每次打开一个文件, 系统首先查看该文件是否已在系统级文件列表中,
如果不在, 则创建该项信息, 否则计数器加1, 关闭一个文件时响应的也会减1, 减少到0时, 系统将系统及文件表中的项删除

- 进程打开一个文件时, 会在进程级文件中添加一项, 每项的信息包括当前文件偏移量(读写文件的位置), 存取权限, 和一个指向
系统级文件表中对应文件项的指针, 系统级文件表中的每一项通过文件描述符(一个非负整数)来表示;

```
#include <stdio.h>

int main(int argc, const char * argv[]) {
    FILE *fp1, *fp2;

    fp2 = fopen("./a.txt", "r");

    fp1 = fopen("./a.txt", "r");

    char buffer[256];

    fscanf(fp1, "%s", buffer);
    printf("%s\n", buffer);

    fscanf(fp2, "%s\n", buffer);
    printf("%s\n", buffer);

    printf("fp2(a.txt): %d\n", fp2->_file);
    printf("fp1(a.txt): %d\n", fp1->_file);

    printf("stdin: %d\n", stdin->_file);
    printf("stderr: %d\n", stderr->_file);
    printf("stdout: %d\n", stdout->_file);

    printf("\n");
    return 0;
}

程序运行时, 默认打开的三个流: stdin, stdout, stderr 他们的_file描述符分别是 0, 1, 2
该程序打开的文件描述符一次从3开始递增
```

## 顺序访问文件

1. 写入文件

写入文件大致分为两步: 定义文件指针和打开文件, 函数fopen有两个参数: 文件名和文件打开模式,

2. 文件打开模式

|模式|说明|
|:--|:--|
|r      | 打开文件,进行读取 |
|w      | 创建文件, 以进行写入, 如果文件已经存在则删除当前内容|
|a      | 追加, 打开或创建文件从文件尾部写入|
|r+     | 打开文件以进行更新(读取和写入)|
|w+     | 创建文件以进行更新, 如果文件已经存在, 则删除当前内容|
|a+     | 追加, 打开或者创建文件以进行更新, 在文件尾部写入|


3. 顺序读取文件
从文件中顺序检索数据, 程序通常从文件的开始读取, 连续读取, 直至找到期望的数据,

`rewind()` 可以程序的文件位置指针(表示文件中将要读取或者写入的下一个字节的位置)重新设置到文件的开头, 注意:
文件位置指针不是指针, 是指定文件中将进行下一次读取或者写入的文职的整数值, 有时候也称为文件偏移量, 是 `FILE` 结构的成员;


4. 随机访问文件

在随机访问文件中, 单个记录的长度通常是固定的, 而且可以直接访问(速度更快), 无需通过其他记录来查找,
适合飞机订票系统, 银行系统, 销售点系统, 和其他需要快速访问特定数据的事务处理系统;

`fwrite()`: 把从内存中特定位置开始的指定数量字节写入到文件位置指针指定的文件位置;
`fread()`: 从文件位置指针指定的 文件位置处 把指定的数量的字节复制到 指定的内存位置;
`fseek()`: 移动文件流的读写位置






---
Title: nginx限流_请求限制(ngx_http_limit_req_module)_爬虫限制策略
Keywords: nginx,高并发限流,请求限制,ngx_http_limit_req_module,爬虫限制策略
Description: 高并发崩溃解决方案，爬虫限制策略
Author: douyacun
Date: 2019-02-02 10:54:57
LastEditTime: 2019-02-02 11:01:18
---

nginx文档阅读：
- [Module ngx_http_limit_req_module](http://nginx.org/en/docs/http/ngx_http_limit_req_module.html)
- [Module ngx_stream_limit_conn_module](http://nginx.org/en/docs/stream/ngx_stream_limit_conn_module.html)


# 限制单一IP地址的请求的处理速率

`nginx.conf`
```conf
http {
    limit_req_zone $binary_remote_addr zone=perip:10m rate=1r/s;
    ; limit_req_zone $server_name zone=perserver:10m rate=10r/s;
    limit_req_log_level error;
    limit_conn_status 503;
    ...

    server {
        location /search/ {
            limit_req zone=perip burst=5 nodelay;
            ; limit_req zone=perserver burst=10;
        }
    }
    
    ...
}
```
配置解释
- limit_req_zone: `http`
  - $binary_remote_addr 4字节的ipv4/16字节的ipv6
  - $server_name 限制域名级别的最大连接数
- limit_req_status: `http, server, location` 默认返回503
- limit_req_log_level: `http, server, location` 配置被限流后，日志记录级别
- limit_req: `http, server, location`, 放在`http`或`server`表示对整个服务限流，`location`对特定服务器限流
  - zone: 选择限流容器，`limit_req_zone`定义的限流容器
  - burst: 缓存的数量，最大请求缓存数量
  - nodelay：不延迟，如果请求缓存超过 count 的值时马上返回 503 错误


# 反爬虫策略

1. 后台对访问进行统计，如果单个IP访问超过阈值，予以封锁,上面可以做限制，但是封锁需要TODO
2. 根据`http_user_agent`限制，允许百度和谷歌爬虫：
  - 禁止Scrapy等工具的抓取
  - 禁止指定UA及UA为空的访问
  - 禁止非GET方式的抓取
```
if ($http_user_agent ~* (Scrapy|Curl|HttpClient)) 
{
     return 403;
}
if ($http_user_agent ~ "FeedDemon|JikeSpider|Indy Library|Alexa Toolbar|AskTbFXTV|AhrefsBot|CrawlDaddy|CoolpadWebkit|Java|Feedly|UniversalFeedParser|ApacheBench|Microsoft URL Control|Swiftbot|ZmEu|oBot|jaunty|Python-urllib|lightDeckReports Bot|YYSpider|DigExt|YisouSpider|HttpClient|MJ12bot|heritrix|EasouSpider|Ezooms|^$" ) 
{
     return 403;            
}
if ($request_method !~ ^(GET)$) 
{
    return 403;
}
```

测试：

`curl -I -A '' https://www.00h.tv`

`curl -I -A 'YisouSpider' https://www.00h.tv`

```
HTTP/1.1 403 Forbidden
Server: nginx/1.14.2
Date: Sat, 02 Feb 2019 07:44:24 GMT
Content-Type: text/html
Content-Length: 169
Connection: keep-alive
```
3. 封禁ip地址

阿里云网段：
```
101.200.0.0/15 
101.37.0.0/16 
101.37.0.0/17 
101.37.0.0/24 
101.37.128.0/17 
103.52.196.0/22 
103.52.196.0/23 
103.52.196.0/24 
103.52.198.0/23 
106.11.0.0/16 
106.11.0.0/17 
106.11.0.0/18 
106.11.1.0/24 
106.11.128.0/17 
106.11.32.0/22 
106.11.36.0/22 
106.11.48.0/21 
106.11.56.0/21 
106.11.64.0/19 
110.173.192.0/20 
110.173.196.0/24 
110.173.208.0/20 
110.75.0.0/16 
110.75.236.0/22 
110.75.239.0/24 
110.75.240.0/20 
110.75.242.0/24 
110.75.243.0/24 
110.75.244.0/22 
110.76.0.0/19 
110.76.21.0/24 
110.76.32.0/20 
110.76.48.0/20 
112.124.0.0/16 
112.125.0.0/16 
112.126.0.0/16 
112.127.0.0/16 
112.74.0.0/16 
112.74.0.0/17 
112.74.116.0/22 
112.74.120.0/22 
112.74.128.0/17 
112.74.32.0/19 
112.74.64.0/22 
112.74.68.0/22 
114.215.0.0/16 
114.55.0.0/16 
114.55.0.0/17 
114.55.128.0/17 
115.124.16.0/22 
115.124.20.0/22 
115.124.24.0/21 
115.28.0.0/16 
115.29.0.0/16 
118.190.0.0/16 
118.190.0.0/17 
118.190.0.0/24 
118.190.128.0/17 
118.31.0.0/16 
118.31.0.0/17 
118.31.0.0/24 
118.31.128.0/17 
119.38.208.0/21 
119.38.216.0/21 
119.38.219.0/24 
119.42.224.0/20 
119.42.242.0/23 
119.42.244.0/22 
119.42.248.0/21 
120.24.0.0/14 
120.24.0.0/15 
120.25.0.0/18 
120.25.104.0/22 
120.25.108.0/24 
120.25.110.0/24 
120.25.111.0/24 
120.25.112.0/23 
120.25.115.0/24 
120.25.136.0/22 
120.25.64.0/19 
120.25.96.0/21 
120.27.0.0/17 
120.27.128.0/17 
120.27.128.0/18 
120.27.192.0/18 
120.55.0.0/16 
120.76.0.0/15 
120.76.0.0/16 
120.77.0.0/16 
120.78.0.0/15 
121.0.16.0/21 
121.0.24.0/22 
121.0.28.0/22 
121.196.0.0/16 
121.197.0.0/16 
121.198.0.0/16 
121.199.0.0/16 
121.40.0.0/14 
121.42.0.0/18 
121.42.0.0/24 
121.42.128.0/18 
121.42.17.0/24 
121.42.192.0/19 
121.42.224.0/19 
121.42.64.0/18 
123.56.0.0/15 
123.56.0.0/16 
123.57.0.0/16 
139.129.0.0/16 
139.129.0.0/17 
139.129.128.0/17 
139.196.0.0/16 
139.196.0.0/17 
139.196.128.0/17 
139.224.0.0/16 
139.224.0.0/17 
139.224.128.0/17 
140.205.0.0/16 
140.205.128.0/18 
140.205.192.0/18 
140.205.32.0/19 
140.205.76.0/24 
182.92.0.0/16 
203.107.0.0/24 
203.107.1.0/24 
203.209.224.0/19 
218.244.128.0/19 
223.4.0.0/16 
223.5.0.0/16 
223.5.5.0/24 
223.6.0.0/16 
223.6.6.0/24 
223.7.0.0/16 
39.100.0.0/14 
39.104.0.0/14 
39.104.0.0/15 
39.104.0.0/24 
39.106.0.0/15 
39.108.0.0/16 
39.108.0.0/17 
39.108.0.0/24 
39.108.128.0/17 
39.96.0.0/13 
39.96.0.0/14 
39.96.0.0/24 
42.120.0.0/16 
42.121.0.0/16 
42.156.128.0/17 
42.96.128.0/17 
45.113.40.0/22 
45.113.40.0/23 
45.113.40.0/24 
45.113.42.0/23 
47.92.0.0/14 
47.92.0.0/15 
47.92.0.0/24 
47.94.0.0/15
```